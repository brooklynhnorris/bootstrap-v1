<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logiri â€” Double D Trailers</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-tertiary: #18181b;
            --bg-card: #141416;
            --border-subtle: #222226;
            --border-medium: #2a2a2f;
            --border-accent: #3a3a4a;
            --text-primary: #e8e8ec;
            --text-secondary: #9898a0;
            --text-muted: #5c5c66;
            --accent-blue: #5b8af5;
            --accent-blue-dim: #2a3a5a;
            --accent-red: #e85454;
            --accent-red-dim: #3a1a1a;
            --accent-yellow: #e8b84a;
            --accent-yellow-dim: #3a2e1a;
            --accent-green: #4ae88a;
            --accent-green-dim: #1a3a2a;
            --accent-purple: #9b7aed;
            --accent-purple-dim: #2a1e4a;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* â”€â”€ Sidebar â”€â”€ */
        #sidebar {
            width: 290px;
            min-width: 290px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }
        #sidebar-header h1 { font-size: 20px; font-weight: 700; color: #fff; letter-spacing: -0.3px; }
        #sidebar-header p { font-size: 11px; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.8px; }

        /* User card */
        .user-card {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 34px; height: 34px; border-radius: 50%;
            background: var(--accent-blue-dim); color: var(--accent-blue);
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 600;
        }
        .user-info { flex: 1; }
        .user-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .user-role { font-size: 11px; color: var(--text-muted); }
        .user-logout {
            font-size: 11px; color: var(--text-muted); text-decoration: none;
            padding: 4px 8px; border-radius: 4px; transition: all 0.15s;
        }
        .user-logout:hover { background: var(--bg-tertiary); color: var(--text-secondary); }

        .sidebar-section { padding: 14px 20px; border-bottom: 1px solid var(--border-subtle); }
        .sidebar-section-title {
            font-size: 10px; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
        }

        /* Task counts */
        .task-summary { display: flex; gap: 6px; }
        .task-stat {
            flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm); padding: 8px; text-align: center;
        }
        .task-stat-number { font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .task-stat-number.urgent { color: var(--accent-red); }
        .task-stat-number.active { color: var(--accent-yellow); }
        .task-stat-number.done { color: var(--accent-green); }
        .task-stat-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 1px; }

        /* Task list */
        #sidebar-scroll { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border-medium) transparent; }

        .task-item {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            transition: border-color 0.15s;
            cursor: default;
        }
        .task-item:hover { border-color: var(--border-accent); }
        .task-item-header { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .task-priority {
            font-size: 9px; font-weight: 600; padding: 2px 6px; border-radius: 3px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .task-priority.urgent { background: var(--accent-red-dim); color: var(--accent-red); }
        .task-priority.high { background: var(--accent-yellow-dim); color: var(--accent-yellow); }
        .task-priority.medium { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .task-priority.low { background: var(--bg-secondary); color: var(--text-muted); }
        .task-assignee { font-size: 10px; color: var(--text-muted); margin-left: auto; }
        .task-title { font-size: 12px; color: var(--text-secondary); line-height: 1.4; }
        .task-actions-row { display: flex; gap: 4px; margin-top: 6px; }
        .task-action-btn {
            font-size: 10px; padding: 3px 8px; border-radius: 3px; border: 1px solid var(--border-subtle);
            background: var(--bg-secondary); color: var(--text-muted); cursor: pointer;
            font-family: 'DM Sans', sans-serif; transition: all 0.15s;
        }
        .task-action-btn:hover { border-color: var(--border-accent); color: var(--text-secondary); }
        .task-action-btn.complete:hover { border-color: var(--accent-green); color: var(--accent-green); background: var(--accent-green-dim); }
        .task-action-btn.start:hover { border-color: var(--accent-yellow); color: var(--accent-yellow); background: var(--accent-yellow-dim); }

        .task-empty { font-size: 12px; color: var(--text-muted); font-style: italic; padding: 4px 0; }

        /* Rechecks */
        .recheck-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 10px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm); margin-bottom: 5px;
        }
        .recheck-info { font-size: 11px; color: var(--text-secondary); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .recheck-date {
            font-size: 10px; font-family: 'JetBrains Mono', monospace;
            padding: 2px 6px; border-radius: 3px; flex-shrink: 0; margin-left: 6px;
        }
        .recheck-date.overdue { background: var(--accent-red-dim); color: var(--accent-red); }
        .recheck-date.upcoming { background: var(--accent-yellow-dim); color: var(--accent-yellow); }
        .recheck-date.future { background: var(--bg-secondary); color: var(--text-muted); }
        .recheck-verify-btn {
            font-size: 9px; padding: 2px 6px; border-radius: 3px; border: 1px solid var(--accent-green);
            background: var(--accent-green-dim); color: var(--accent-green); cursor: pointer;
            font-family: 'DM Sans', sans-serif; margin-left: 4px; transition: all 0.15s;
        }
        .recheck-verify-btn:hover { background: var(--accent-green); color: #fff; }

        /* â”€â”€ Main Chat â”€â”€ */
        #main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        #chat-header {
            padding: 12px 24px; border-bottom: 1px solid var(--border-subtle);
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-secondary);
        }
        #chat-header-left { display: flex; align-items: center; gap: 10px; }
        .pulse-dot { width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        #chat-header-label { font-size: 13px; color: var(--text-secondary); }
        .header-btns { display: flex; gap: 6px; }
        .header-btn {
            background: var(--bg-tertiary); border: 1px solid var(--border-medium);
            color: var(--text-secondary); padding: 6px 12px; border-radius: var(--radius-sm);
            font-size: 12px; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.15s;
        }
        .header-btn:hover { background: var(--border-medium); color: var(--text-primary); }

        /* Messages */
        #messages {
            flex: 1; overflow-y: auto; padding: 24px 32px;
            display: flex; flex-direction: column; gap: 20px;
            scrollbar-width: thin; scrollbar-color: var(--border-medium) transparent;
        }
        .message { max-width: 820px; line-height: 1.7; font-size: 14px; animation: fadeIn 0.25s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        .message.user {
            align-self: flex-end; background: #1a1a2e; border: 1px solid #2a2a5a;
            padding: 10px 16px; border-radius: var(--radius-lg) var(--radius-lg) 3px var(--radius-lg);
            color: var(--text-primary); font-size: 14px;
        }
        .message.assistant { align-self: flex-start; width: 100%; }
        .message.assistant .bubble {
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            padding: 20px 24px; border-radius: 3px var(--radius-lg) var(--radius-lg) var(--radius-lg);
        }

        /* Markdown */
        .bubble h1 { font-size: 18px; font-weight: 700; color: #fff; margin: 20px 0 8px 0; letter-spacing: -0.3px; }
        .bubble h1:first-child { margin-top: 0; }
        .bubble h2 { font-size: 15px; font-weight: 600; color: #fff; margin: 18px 0 6px 0; padding-bottom: 6px; border-bottom: 1px solid var(--border-subtle); }
        .bubble h3 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 14px 0 4px 0; }
        .bubble p { margin: 8px 0; color: var(--text-secondary); }
        .bubble strong { color: var(--text-primary); font-weight: 600; }
        .bubble em { color: var(--text-secondary); }
        .bubble ul, .bubble ol { margin: 8px 0; padding-left: 20px; color: var(--text-secondary); }
        .bubble li { margin: 4px 0; }
        .bubble li strong { color: var(--text-primary); }
        .bubble code {
            font-family: 'JetBrains Mono', monospace; font-size: 12px;
            background: var(--bg-tertiary); border: 1px solid var(--border-subtle);
            padding: 1px 5px; border-radius: 3px; color: var(--accent-blue);
        }
        .bubble pre { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: 12px 16px; margin: 10px 0; overflow-x: auto; }
        .bubble pre code { background: none; border: none; padding: 0; color: var(--text-secondary); }
        .bubble hr { border: none; border-top: 1px solid var(--border-subtle); margin: 16px 0; }
        .bubble table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 13px; }
        .bubble th { text-align: left; padding: 8px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--text-primary); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .bubble td { padding: 8px 12px; border: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .bubble tr:hover td { background: rgba(255,255,255,0.02); }

        /* Chat quick actions */
        .chat-actions {
            display: flex; gap: 6px; flex-wrap: wrap; margin-top: 14px; padding-top: 14px;
            border-top: 1px solid var(--border-subtle);
        }
        .chat-btn {
            background: var(--bg-tertiary); border: 1px solid var(--border-medium);
            color: var(--text-secondary); padding: 6px 12px; border-radius: var(--radius-sm);
            font-size: 11px; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.15s;
        }
        .chat-btn:hover { background: var(--border-medium); color: var(--text-primary); border-color: var(--border-accent); }

        /* Typing */
        .typing-indicator { display: none; align-self: flex-start; padding: 8px 0; }
        .typing-dots { display: flex; gap: 4px; align-items: center; }
        .typing-dots span { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: bounce 1.2s infinite; }
        .typing-dots span:nth-child(2) { animation-delay: 0.15s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.3s; }
        @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-4px); opacity: 1; } }

        /* Input */
        #input-area { padding: 14px 32px 18px; border-top: 1px solid var(--border-subtle); display: flex; gap: 10px; background: var(--bg-secondary); }
        #input {
            flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-medium);
            border-radius: var(--radius-md); padding: 12px 16px; color: var(--text-primary);
            font-size: 14px; resize: none; height: 48px; line-height: 24px;
            font-family: 'DM Sans', sans-serif; transition: border-color 0.15s;
        }
        #input:focus { outline: none; border-color: var(--accent-blue); }
        #input::placeholder { color: var(--text-muted); }
        #send {
            background: var(--accent-blue-dim); border: 1px solid var(--accent-blue);
            color: var(--accent-blue); padding: 0 20px; border-radius: var(--radius-md);
            cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif;
            transition: all 0.15s;
        }
        #send:hover { background: var(--accent-blue); color: #fff; }
        #send:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Add task modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: 12px; padding: 24px; width: 420px; max-width: 90vw;
        }
        .modal h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        .modal-field { margin-bottom: 12px; }
        .modal-field label { display: block; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .modal-field input, .modal-field select, .modal-field textarea {
            width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-medium);
            border-radius: 6px; padding: 8px 12px; color: var(--text-primary); font-size: 13px;
            font-family: 'DM Sans', sans-serif;
        }
        .modal-field textarea { height: 60px; resize: vertical; }
        .modal-field input:focus, .modal-field select:focus, .modal-field textarea:focus { outline: none; border-color: var(--accent-blue); }
        .modal-btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
        .modal-btn {
            padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500;
            font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.15s;
        }
        .modal-btn.cancel { background: var(--bg-tertiary); border: 1px solid var(--border-medium); color: var(--text-secondary); }
        .modal-btn.cancel:hover { background: var(--border-medium); }
        .modal-btn.save { background: var(--accent-blue-dim); border: 1px solid var(--accent-blue); color: var(--accent-blue); }
        .modal-btn.save:hover { background: var(--accent-blue); color: #fff; }

        @media (max-width: 768px) {
            #sidebar { display: none; }
            #messages { padding: 16px; }
            #input-area { padding: 12px 16px; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar">
        <div id="sidebar-header">
            <h1>Logiri</h1>
            <p>SEO Intelligence Â· Double D Trailers</p>
        </div>

        <!-- Logged in user -->
        <div class="user-card">
            <div class="user-avatar">{{ userName[:2]|upper }}</div>
            <div class="user-info">
                <div class="user-name">{{ userName }}</div>
                <div class="user-role">{{ userRole }}</div>
            </div>
            <a href="{{ logout_path() }}" class="user-logout">Logout</a>
        </div>

        <div id="sidebar-scroll">
            <!-- Task counts -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Overview</div>
                <div class="task-summary">
                    <div class="task-stat">
                        <div class="task-stat-number urgent" id="count-urgent">{{ taskCounts.urgent }}</div>
                        <div class="task-stat-label">Urgent</div>
                    </div>
                    <div class="task-stat">
                        <div class="task-stat-number active" id="count-active">{{ taskCounts.active }}</div>
                        <div class="task-stat-label">Active</div>
                    </div>
                    <div class="task-stat">
                        <div class="task-stat-number done" id="count-done">{{ taskCounts.done }}</div>
                        <div class="task-stat-label">Done</div>
                    </div>
                </div>
            </div>

            <!-- Active tasks -->
            <div class="sidebar-section" style="border-bottom: none;">
                <div class="sidebar-section-title">
                    Tasks
                    <button class="task-action-btn" onclick="openAddTask()" style="font-size: 10px;">+ Add</button>
                </div>
                <div id="task-list">
                    {% if tasks is empty %}
                        <div class="task-empty">No active tasks. Ask Logiri for a briefing to generate tasks.</div>
                    {% else %}
                        {% for task in tasks %}
                        <div class="task-item" id="task-{{ task.id }}">
                            <div class="task-item-header">
                                <span class="task-priority {{ task.priority }}">{{ task.priority }}</span>
                                <span class="task-assignee">{{ task.assigned_to ?? 'Unassigned' }}</span>
                            </div>
                            <div class="task-title">{{ task.title }}</div>
                            <div class="task-actions-row">
                                {% if task.status == 'pending' %}
                                    <button class="task-action-btn start" onclick="startTask({{ task.id }})">â–¶ Start</button>
                                {% endif %}
                                {% if task.status != 'done' %}
                                    <button class="task-action-btn complete" onclick="completeTask({{ task.id }})">âœ“ Complete</button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <!-- Rechecks -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Verification Rechecks</div>
                <div id="recheck-list">
                    {% if rechecks is empty %}
                        <div class="task-empty">No rechecks pending</div>
                    {% else %}
                        {% for r in rechecks %}
                        <div class="recheck-item">
                            <span class="recheck-info">{{ r.title }}</span>
                            <span class="recheck-date upcoming">{{ r.recheck_date }}</span>
                            <button class="recheck-verify-btn" onclick="verifyRecheck({{ r.id }})">Verify</button>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal-overlay" id="add-task-modal">
        <div class="modal">
            <h3>Add Task</h3>
            <div class="modal-field">
                <label>Title</label>
                <input type="text" id="new-task-title" placeholder="Task description...">
            </div>
            <div class="modal-field">
                <label>Assigned To</label>
                <select id="new-task-assignee">
                    <option value="Brook">Brook (SEO + Content)</option>
                    <option value="Kalib">Kalib (Sales)</option>
                    <option value="Brad">Brad (Marketing)</option>
                </select>
            </div>
            <div class="modal-field">
                <label>Priority</label>
                <select id="new-task-priority">
                    <option value="high">High</option>
                    <option value="medium" selected>Medium</option>
                    <option value="urgent">Urgent</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="modal-field">
                <label>Estimated Hours</label>
                <input type="number" id="new-task-hours" value="1" min="0.5" step="0.5">
            </div>
            <div class="modal-field">
                <label>Recheck Type</label>
                <select id="new-task-recheck">
                    <option value="">None</option>
                    <option value="cannibalization_fix">Cannibalization Fix (14 days)</option>
                    <option value="intent_mismatch">Intent Mismatch (14 days)</option>
                    <option value="ranking_drop">Ranking Drop (28 days)</option>
                    <option value="404_fix">404 Fix (7 days)</option>
                    <option value="sitemap_fix">Sitemap Fix (7 days)</option>
                    <option value="weak_page">Weak Page (14 days)</option>
                    <option value="zero_click">Zero Click (14 days)</option>
                </select>
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeAddTask()">Cancel</button>
                <button class="modal-btn save" onclick="saveNewTask()">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Main Chat -->
    <div id="main">
        <div id="chat-header">
            <div id="chat-header-left">
                <div class="pulse-dot"></div>
                <span id="chat-header-label">Logiri is online</span>
            </div>
            <div class="header-btns">
                <button class="header-btn" onclick="resetChat()">+ New Chat</button>
            </div>
        </div>

        <div id="messages"></div>

        <div class="typing-indicator" id="typing">
            <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>

        <div id="input-area">
            <textarea id="input" placeholder="Ask Logiri about your SEO, tasks, or priorities..." rows="1"></textarea>
            <button id="send">Send</button>
        </div>
    </div>

    <script>
        marked.setOptions({ breaks: true, gfm: true, headerIds: false, mangle: false });

        const USER_NAME = '{{ userName }}';
        const USER_ROLE = '{{ userRole }}';
        let messages = [];
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('input');
        const sendEl = document.getElementById('send');
        const typingEl = document.getElementById('typing');

        // â”€â”€ Chat â”€â”€
        async function sendMessage(text) {
            messages.push({ role: 'user', content: text });
            appendMessage('user', text);
            inputEl.value = '';
            sendEl.disabled = true;
            typingEl.style.display = 'block';
            messagesEl.scrollTop = messagesEl.scrollHeight;

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages })
                });
                const data = await res.json();
                const reply = data.response || data.error || 'No response.';
                messages.push({ role: 'assistant', content: reply });
                appendMessage('assistant', reply);
            } catch (e) {
                appendMessage('assistant', 'Error reaching Logiri. Please try again.');
            }

            typingEl.style.display = 'none';
            sendEl.disabled = false;
            inputEl.focus();
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = 'message ' + role;

            if (role === 'assistant') {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.innerHTML = marked.parse(text);
                div.appendChild(bubble);

                if (text.length > 200) {
                    const actions = document.createElement('div');
                    actions.className = 'chat-actions';
                    actions.innerHTML = `
                        <button class="chat-btn" onclick="sendMessage('What should ${USER_NAME} work on today?')">ðŸ“‹ My Tasks</button>
                        <button class="chat-btn" onclick="sendMessage('Show team status and blockers')">ðŸ‘¥ Team Status</button>
                        <button class="chat-btn" onclick="sendMessage('Show me quick wins under 2 hours')">âš¡ Quick Wins</button>
                        <button class="chat-btn" onclick="sendMessage('What rechecks are due?')">ðŸ”„ Rechecks Due</button>
                        <button class="chat-btn" onclick="openAddTask()">+ Add Task</button>
                    `;
                    bubble.appendChild(actions);
                }
            } else {
                div.textContent = text;
            }

            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function resetChat() {
            messages = [];
            messagesEl.innerHTML = '';
            sendMessage('Hello, give me my briefing for today.');
        }

        // â”€â”€ Task Management â”€â”€
        async function startTask(id) {
            await fetch(`/api/tasks/${id}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'in_progress' })
            });
            location.reload();
        }

        async function completeTask(id) {
            const res = await fetch(`/api/tasks/${id}/complete`, { method: 'POST' });
            const data = await res.json();
            if (data.recheck_date) {
                sendMessage(`I just completed a task (ID: ${id}). The recheck is set for ${data.recheck_date} (${data.recheck_days} days). What should I work on next?`);
            }
            refreshSidebar();
        }

        async function verifyRecheck(id) {
            const passed = confirm('Did this task pass verification? (OK = Pass, Cancel = Fail)');
            await fetch(`/api/tasks/${id}/verify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ passed })
            });
            if (passed) {
                sendMessage(`Recheck for task ${id} PASSED verification. Update the team.`);
            } else {
                sendMessage(`Recheck for task ${id} FAILED verification. What should we do to fix this?`);
            }
            refreshSidebar();
        }

        // â”€â”€ Add Task Modal â”€â”€
        function openAddTask() {
            document.getElementById('add-task-modal').classList.add('active');
        }
        function closeAddTask() {
            document.getElementById('add-task-modal').classList.remove('active');
        }
        async function saveNewTask() {
            const task = {
                title: document.getElementById('new-task-title').value,
                assigned_to: document.getElementById('new-task-assignee').value,
                priority: document.getElementById('new-task-priority').value,
                estimated_hours: parseFloat(document.getElementById('new-task-hours').value),
                recheck_type: document.getElementById('new-task-recheck').value || null,
            };
            if (!task.title) return alert('Enter a task title');

            await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(task)
            });
            closeAddTask();
            document.getElementById('new-task-title').value = '';
            refreshSidebar();
        }

        // â”€â”€ Refresh sidebar data â”€â”€
        async function refreshSidebar() {
            try {
                const res = await fetch('/api/tasks?status=');
                const tasks = await res.json();

                let urgent = 0, active = 0, done = 0;
                tasks.forEach(t => {
                    if (t.status === 'done') done++;
                    else if (t.status === 'in_progress') active++;
                    if (t.priority === 'urgent' || t.priority === 'high') urgent++;
                });

                document.getElementById('count-urgent').textContent = urgent;
                document.getElementById('count-active').textContent = active;
                document.getElementById('count-done').textContent = done;

                const taskList = document.getElementById('task-list');
                const activeTasks = tasks.filter(t => t.status !== 'done');
                if (activeTasks.length === 0) {
                    taskList.innerHTML = '<div class="task-empty">No active tasks.</div>';
                } else {
                    taskList.innerHTML = activeTasks.slice(0, 15).map(t => `
                        <div class="task-item" id="task-${t.id}">
                            <div class="task-item-header">
                                <span class="task-priority ${t.priority}">${t.priority}</span>
                                <span class="task-assignee">${t.assigned_to || 'Unassigned'}</span>
                            </div>
                            <div class="task-title">${t.title}</div>
                            <div class="task-actions-row">
                                ${t.status === 'pending' ? `<button class="task-action-btn start" onclick="startTask(${t.id})">â–¶ Start</button>` : ''}
                                <button class="task-action-btn complete" onclick="completeTask(${t.id})">âœ“ Complete</button>
                            </div>
                        </div>
                    `).join('');
                }

                // Refresh rechecks
                const recheckRes = await fetch('/api/rechecks');
                const rechecks = await recheckRes.json();
                const recheckList = document.getElementById('recheck-list');
                if (rechecks.length === 0) {
                    recheckList.innerHTML = '<div class="task-empty">No rechecks pending</div>';
                } else {
                    recheckList.innerHTML = rechecks.map(r => `
                        <div class="recheck-item">
                            <span class="recheck-info">${r.title}</span>
                            <span class="recheck-date upcoming">${r.recheck_date}</span>
                            <button class="recheck-verify-btn" onclick="verifyRecheck(${r.id})">Verify</button>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to refresh sidebar:', e);
            }
        }

        // â”€â”€ Init â”€â”€
        window.addEventListener('load', () => {
            sendMessage('Hello ' + USER_NAME + ', give me my briefing for today.');
        });

        sendEl.addEventListener('click', () => {
            const text = inputEl.value.trim();
            if (text) sendMessage(text);
        });

        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const text = inputEl.value.trim();
                if (text) sendMessage(text);
            }
        });

        inputEl.addEventListener('input', () => {
            inputEl.style.height = '48px';
            inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
        });

        // Refresh sidebar every 60 seconds
        setInterval(refreshSidebar, 60000);
    </script>
</body>
</html>
